FROM registry.access.redhat.com/ubi8/ubi-init

ENV THRUK_VERSION=3.02
ENV THRUK_USER=thruk

USER root
RUN yum -y install wget perl git automake make gcc rsync gd-devel mariadb-connector-c-devel patch httpd mod_fcgid

# Workaround until chrpath is available in baseOS repos
ENV ARCH='eval uname -m'
RUN yum -y install https://rpmfind.net/linux/centos/8-stream/BaseOS/$ARCH/os/Packages/chrpath-0.16-7.el8.$ARCH.rpm

RUN groupadd -r $THRUK_USER && useradd -r $THRUK_USER -g $THRUK_USER
RUN systemctl enable httpd.service

USER thruk
RUN git clone https://github.com/sni/thruk_libs.git /tmp/thruk_libs
WORKDIR /tmp/thruk_libs
RUN make
RUN git clone https://github.com/sni/Thruk.git /tmp/Thruk
WORKDIR /tmp/Thruk
RUN ./configure
RUN make


CMD ["/sbin/init"]



# Add consol repo and install thruk
#RUN wget --no-check-certificate https://labs.consol.de/repo/stable/rhel8/i386/labs-consol-stable.rhel8.noarch.rpm
#RUN rpm -Uvh ./labs-consol-stable.rhel8.noarch.rpm
#RUN yum -y install --nogpgcheck thruk-$THRUK_VERSION
# Remove entitlements

#COPY ./thruk_local.conf /etc/thruk/

